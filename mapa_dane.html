<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa DANE - Zoom por Código</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    #controls { position: absolute; top:10px; left:10px; z-index:1000;
                background: rgba(255,255,255,0.95); padding:8px; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.2); }
    .highlight { stroke: #ff7800; weight: 3; fill-opacity: 0.3; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <div>
      <label>Depto DANE (2 dígitos): <input id="dpto" size="6" placeholder="01"/></label>
    </div>
    <div>
      <label>Mun DANE (5 dígitos): <input id="mun" size="7" placeholder="01001"/></label>
    </div>
    <div style="margin-top:6px;">
      <button id="btnZoom">Zoom</button>
      <button id="btnReset">Reset</button>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

  <script>
    // Configuración inicial del mapa
    const map = L.map('map', { minZoom: 3 }).setView([4.6, -74.08], 6);

    // Capa base (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Variables globales para capas
    let deptosLayer = L.geoJSON(null, { style: styleDepto }).addTo(map);
    let munLayer = L.geoJSON(null, { style: styleMun }).addTo(map);
    let highlightLayer = L.geoJSON(null, { style: highlightStyle }).addTo(map);

    // Funciones de estilo
    function styleDepto(feature) {
      return {
        color: '#333',
        weight: 1,
        fillOpacity: 0.05
      };
    }
    function styleMun(feature) {
      return {
        color: '#666',
        weight: 0.5,
        fillOpacity: 0.02
      };
    }
    function highlightStyle(feature) {
      return {
        color: '#ff7800',
        weight: 2.5,
        fillOpacity: 0.35
      };
    }

    // Cargar TopoJSONs (se asume que están en la misma carpeta)
    Promise.all([
      fetch('departamentos.topojson').then(r => r.json()),
      fetch('municipios.topojson').then(r => r.json())
    ]).then(([topoDeptos, topoMuns]) => {
      // Detectar nombre de objeto interno (común en TopoJSON)
      const dptoObjName = Object.keys(topoDeptos.objects)[0];
      const munObjName = Object.keys(topoMuns.objects)[0];

      // Convertir a GeoJSON
      const deptosGeo = topojson.feature(topoDeptos, topoDeptos.objects[dptoObjName]);
      const munsGeo = topojson.feature(topoMuns, topoMuns.objects[munObjName]);

      // Normalizar propiedades para buscar códigos (agrega propiedades auxiliares)
      normalizeProperties(deptosGeo.features, ['DANE_DPTO','dane_dep','CD_DPTO','DPTO_COD','cod_dpto','DANE']);
      normalizeProperties(munsGeo.features, ['DANE_MPIO','dane_mun','CD_MPIO','MUN_COD','cod_mun','DANE']);

      // Añadir a capas
      deptosLayer.addData(deptosGeo);
      munLayer.addData(munsGeo);

      // Ajustar vista a Colombia
      map.fitBounds(deptosLayer.getBounds(), { maxZoom: 7 });

      // Hacer clickable: al click, mostrar popup con código
      deptosLayer.eachLayer(l => {
        const props = l.feature.properties || {};
        l.on('click', () => {
          L.popup().setLatLng(l.getBounds().getCenter())
            .setContent(`<b>${props.NOMBRE || props.name || 'Departamento'}</b><br/>Código: ${props._DANE || 'n/a'}`)
            .openOn(map);
        });
      });
      munLayer.eachLayer(l => {
        const props = l.feature.properties || {};
        l.on('click', () => {
          L.popup().setLatLng(l.getBounds().getCenter())
            .setContent(`<b>${props.NAME || props.NOMBRE || 'Municipio'}</b><br/>Código: ${props._DANE || 'n/a'}`)
            .openOn(map);
        });
      });

    }).catch(err => {
      console.error('Error cargando TopoJSON:', err);
      alert('No se pudieron cargar los archivos TopoJSON. Revisa la consola y asegúrate de que departamentos.topojson y municipios.topojson estén en la misma carpeta.');
    });

    // Normaliza propiedades: busca en la feature propiedades que contengan el código DANE.
    function normalizeProperties(features, candidates) {
      features.forEach(f => {
        const props = f.properties || {};
        // buscar el campo existente con alguno de los nombres candidatos
        let found = null;
        for (const c of candidates) {
          if (props.hasOwnProperty(c)) { found = c; break; }
        }
        // si no se encontró, probar nombres en mayúsculas/minúsculas genéricos
        if (!found) {
          for (const key of Object.keys(props)) {
            const lower = key.toLowerCase();
            if (lower.includes('dane') || lower.includes('codigo') || lower.includes('cod') || lower.includes('divipola')) {
              found = key; break;
            }
          }
        }
        // si se encontró un campo, estandarizar como _DANE
        if (found) {
          let val = String(props[found]).trim();
          // rellenar ceros si parece depto corto (2 dígitos) - no forzamos aquí
          props._DANE = val;
        } else {
          props._DANE = null;
        }
        // guardar propiedades normalizadas de nombre si existen
        props._NAME = props.NAME || props.NOMBRE || props.name || null;
      });
    }

    // Función pública: hace zoom al departamento y/o municipio por código DANE
    // deptoCodigo puede ser '01' o '1' o 1; muniCodigo '01001' o 1001 o '01001'
    function zoomTo(deptoCodigo, muniCodigo) {
      // limpiar highlight
      highlightLayer.clearLayers();

      // Normalizar inputs a strings sin espacios
      const dptoStr = deptoCodigo !== undefined && deptoCodigo !== null ? String(deptoCodigo).padStart(2, '0') : null;
      const muniStr = muniCodigo !== undefined && muniCodigo !== null ? String(muniCodigo).padStart(5, '0') : null;

      // Buscar municipio si se dio
      if (muniStr) {
        let foundMun = null;
        munLayer.eachLayer(layer => {
          const props = layer.feature.properties || {};
          const code = props._DANE ? String(props._DANE).padStart(5,'0') : null;
          if (code === muniStr) { foundMun = layer; }
        });
        if (foundMun) {
          highlightLayer.addData(foundMun.feature);
          map.fitBounds(foundMun.getBounds(), { maxZoom: 12, padding: [30,30] });
          return;
        }
        // si no encontramos municipio, intentar encontrar por combinación depto+mun
        // (a veces el código municipal incluye el código de departamento)
      }

      // Si no hubo municipio o no se encontró, buscar departamento
      if (dptoStr) {
        let foundDpto = null;
        deptosLayer.eachLayer(layer => {
          const props = layer.feature.properties || {};
          // algunos topojson guardan 2 dígitos, otros 3, etc. Comparamos por sufijo o prefijo
          const code = props._DANE ? String(props._DANE).padStart(2,'0') : null;
          // aceptar si code terminaWith dptoStr or equals
          if (code && (code === dptoStr || code.endsWith(dptoStr) || code.startsWith(dptoStr))) {
            foundDpto = layer;
          }
        });
        if (foundDpto) {
          highlightLayer.addData(foundDpto.feature);
          map.fitBounds(foundDpto.getBounds(), { maxZoom: 9, padding: [20,20] });
          return;
        }
      }

      // Si no hay nada, mensaje y reset al país
      alert('No se encontró el código proporcionado en las capas cargadas.');
    }

    // Botones UI
    document.getElementById('btnZoom').addEventListener('click', () => {
      const d = document.getElementById('dpto').value.trim();
      const m = document.getElementById('mun').value.trim();
      if (!d && !m) { alert('Ingresa al menos un código de departamento (2 dígitos) o municipio (5 dígitos).'); return; }
      zoomTo(d || null, m || null);
    });
    document.getElementById('btnReset').addEventListener('click', () => {
      highlightLayer.clearLayers();
      map.fitBounds(deptosLayer.getBounds(), { maxZoom: 7 });
    });

    // Exportar función para uso externo (por ejemplo desde Power BI)
    window.zoomToDANE = zoomTo;
  </script>
</body>
</html>
